name: Release exports

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      force:
        description: 'Force export even if no relevant files changed'
        required: false
        default: 'false'
      tag:
        description: 'Release tag to upload assets to (workflow_dispatch only)'
        required: false
        default: ''

jobs:
  export-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine whether exports need regeneration
        id: regen
        shell: bash
        run: |
          set -euo pipefail
          force="${{ github.event_name == 'workflow_dispatch' && inputs.force || 'false' }}"

          if [[ "${{ github.event_name }}" == "release" ]]; then
            tag="${{ github.event.release.tag_name }}"
          else
            tag="${{ inputs.tag }}"
          fi

          if [[ -z "${tag}" ]]; then
            echo "should_regen=false" >> "$GITHUB_OUTPUT"
            echo "tag=" >> "$GITHUB_OUTPUT"
            echo "reason=No tag provided." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

          if [[ "${force}" == "true" ]]; then
            echo "should_regen=true" >> "$GITHUB_OUTPUT"
            echo "reason=Forced by workflow input." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find previous v* tag (semver-ish) to diff against.
          prev_tag="$(git tag -l --sort=-v:refname | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | grep -v -F "${tag}" | head -n 1 || true)"

          if [[ -z "${prev_tag}" ]]; then
            echo "should_regen=true" >> "$GITHUB_OUTPUT"
            echo "reason=No previous tag found." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "prev_tag=${prev_tag}" >> "$GITHUB_OUTPUT"

          changed="$(git diff --name-only "${prev_tag}" "${tag}" -- src scripts fonts | wc -l | tr -d ' ')"
          if [[ "${changed}" != "0" ]]; then
            echo "should_regen=true" >> "$GITHUB_OUTPUT"
            echo "reason=Relevant files changed (${changed} file(s))." >> "$GITHUB_OUTPUT"
          else
            echo "should_regen=false" >> "$GITHUB_OUTPUT"
            echo "reason=No changes under src/scripts/fonts since ${prev_tag}." >> "$GITHUB_OUTPUT"
          fi

      - name: Skip (no regeneration needed)
        if: steps.regen.outputs.should_regen != 'true'
        run: |
          echo "Skipping export."
          echo "Reason: ${{ steps.regen.outputs.reason }}"

      - name: Install OpenSCAD + common fonts
        if: steps.regen.outputs.should_regen == 'true'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y openscad fonts-liberation fonts-dejavu-core zip

      - name: Export STLs
        if: steps.regen.outputs.should_regen == 'true'
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./scripts/export.sh
          OPENSCAD_FA=12 OPENSCAD_FS=1 ./scripts/export.sh

      - name: Package STLs
        if: steps.regen.outputs.should_regen == 'true'
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.regen.outputs.tag }}"
          zip -j "exports/stl/ewc3-test-hole-generator-${tag}-stl.zip" exports/stl/*.stl

      - name: Collect asset names
        if: steps.regen.outputs.should_regen == 'true'
        id: assets
        shell: bash
        run: |
          set -euo pipefail

          {
            echo 'names<<EOF'
            for f in exports/stl/*.stl exports/stl/*.zip; do
              test -e "$f" || continue
              basename "$f"
            done
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Delete existing assets with same names
        if: steps.regen.outputs.should_regen == 'true'
        uses: actions/github-script@v7
        env:
          ASSET_NAMES: ${{ steps.assets.outputs.names }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = `${{ steps.regen.outputs.tag }}`;
            const raw = process.env.ASSET_NAMES || '';
            const desired = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

            if (!tag) {
              core.info('No tag; skipping asset deletion.');
              return;
            }
            if (desired.length === 0) {
              core.info('No assets to upload; skipping asset deletion.');
              return;
            }

            const desiredSet = new Set(desired);
            core.info(`Will replace ${desired.length} asset(s) on release ${tag}.`);

            const rel = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
            const assets = rel.data.assets || [];
            const toDelete = assets.filter(a => desiredSet.has(a.name));

            if (toDelete.length === 0) {
              core.info('No matching existing assets to delete.');
              return;
            }

            for (const asset of toDelete) {
              core.info(`Deleting existing asset: ${asset.name}`);
              await github.rest.repos.deleteReleaseAsset({ owner, repo, asset_id: asset.id });
            }

      - name: Upload release assets
        if: steps.regen.outputs.should_regen == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.regen.outputs.tag }}
          files: |
            exports/stl/*.stl
            exports/stl/*.zip
