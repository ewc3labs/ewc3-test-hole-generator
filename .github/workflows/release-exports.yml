name: Release exports

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      force:
        description: 'Force export even if tag is not vX.0.0'
        required: false
        default: 'false'

jobs:
  export-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine if this is a major release
        id: major
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.event.release.tag_name }}"
          force="${{ inputs.force }}"

          if [[ "${force}" == "true" ]]; then
            echo "is_major=true" >> "$GITHUB_OUTPUT"
            echo "tag=${tag:-manual}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -z "${tag}" ]]; then
            echo "is_major=false" >> "$GITHUB_OUTPUT"
            echo "tag=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$tag" =~ ^v([0-9]+)\.0\.0$ ]]; then
            echo "is_major=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_major=false" >> "$GITHUB_OUTPUT"
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Skip (not a major release)
        if: steps.major.outputs.is_major != 'true'
        run: echo "Not a major release (expected tag vX.0.0). Skipping export."

      - name: Install OpenSCAD + common fonts
        if: steps.major.outputs.is_major == 'true'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y openscad fonts-liberation fonts-dejavu-core zip

      - name: Export STLs
        if: steps.major.outputs.is_major == 'true'
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./scripts/export.sh
          OPENSCAD_FA=12 OPENSCAD_FS=1 ./scripts/export.sh

      - name: Package STLs
        if: steps.major.outputs.is_major == 'true'
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.major.outputs.tag }}"
          zip -j "exports/stl/ewc3-test-hole-generator-${tag}-stl.zip" exports/stl/*.stl

      - name: Upload release assets
        if: steps.major.outputs.is_major == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            exports/stl/*.stl
            exports/stl/*.zip
